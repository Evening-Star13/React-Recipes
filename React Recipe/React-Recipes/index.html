<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recipe Manager Pro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- HTML2PDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- React and ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
  </head>
  <body
    class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300"
  >
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Sample recipes data
      const sampleRecipes = [
        {
          id: "1",
          name: "Classic Spaghetti Bolognese",
          type: "Dinner",
          dietaryTypes: ["Dairy-Free"],
          prepTime: 20,
          cookTime: 40,
          additionalTime: 0,
          calories: 650,
          protein: 32,
          carbs: 78,
          fat: 22,
          ingredients: [
            "1 lb ground beef",
            "1 onion, diced",
            "3 cloves garlic, minced",
            "2 cans (14 oz each) crushed tomatoes",
            "1 lb spaghetti",
            "2 tbsp olive oil",
            "Salt and pepper to taste",
            "Fresh basil for garnish",
          ],
          directions: [
            "Heat olive oil in a large pot over medium heat.",
            "Add onions and garlic, sauté until translucent.",
            "Add ground beef and cook until browned.",
            "Pour in crushed tomatoes and seasonings.",
            "Simmer for 30 minutes.",
            "Cook spaghetti according to package directions.",
            "Serve sauce over pasta with fresh basil.",
          ],
          servings: 4,
          createdAt: new Date().toISOString(),
          isFavorite: false,
          image: null,
          video: null,
        },
        {
          id: "2",
          name: "Garden Salad",
          type: "Lunch",
          dietaryTypes: ["Vegan", "Gluten-Free"],
          prepTime: 15,
          cookTime: 0,
          additionalTime: 0,
          calories: 200,
          protein: 5,
          carbs: 20,
          fat: 12,
          ingredients: [
            "2 cups mixed greens",
            "1 tomato, diced",
            "1 onion, sliced",
            "1 cucumber, sliced",
            "2 tbsp olive oil",
            "1 tbsp balsamic vinegar",
            "Salt and pepper to taste",
          ],
          directions: [
            "Combine greens, tomato, onion, and cucumber in a bowl.",
            "Drizzle with olive oil and balsamic vinegar.",
            "Season with salt and pepper.",
            "Toss and serve immediately.",
          ],
          servings: 2,
          createdAt: new Date().toISOString(),
          isFavorite: false,
          image: null,
          video: null,
        },
      ];

      // Storage keys
      const STORAGE_KEYS = {
        RECIPES: "recipes",
        MEAL_PLAN: "mealPlan",
        SHOPPING_LIST: "shoppingList",
        THEME: "theme",
      };

      // Helper functions
      const escapeHTML = (str) => {
        if (!str) return "";
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      };

      const parseIngredient = (ingredient) => {
        const regex = /^([\d./]+)?\s*([^\d\s].*)/;
        const match = ingredient.match(regex);
        if (match) {
          const quantity = match[1] ? eval(match[1]) : null;
          const rest = match[2];
          return { quantity, rest };
        }
        return { quantity: null, rest: ingredient };
      };

      const formatQuantity = (quantity) => {
        if (!quantity) return "";
        if (quantity % 1 === 0) return quantity;
        const tolerance = 0.01;
        const fractions = [
          { decimal: 0.25, fraction: "1/4" },
          { decimal: 0.33, fraction: "1/3" },
          { decimal: 0.5, fraction: "1/2" },
          { decimal: 0.66, fraction: "2/3" },
          { decimal: 0.75, fraction: "3/4" },
        ];
        for (let f of fractions) {
          if (Math.abs((quantity % 1) - f.decimal) < tolerance) {
            const whole = Math.floor(quantity);
            return whole > 0 ? `${whole} ${f.fraction}` : f.fraction;
          }
        }
        return quantity.toFixed(2);
      };

      const normalizeIngredient = (ingredient) => {
        const { rest } = parseIngredient(ingredient);
        // Comprehensive list of units to remove
        const units = [
          "tbsp",
          "tablespoon",
          "tablespoons",
          "tsp",
          "teaspoon",
          "teaspoons",
          "cup",
          "cups",
          "oz",
          "ounce",
          "ounces",
          "lb",
          "pound",
          "pounds",
          "g",
          "gram",
          "grams",
          "kg",
          "kilogram",
          "kilograms",
          "ml",
          "milliliter",
          "milliliters",
          "l",
          "liter",
          "liters",
          "clove",
          "cloves",
          "can",
          "cans",
          "jar",
          "jars",
          "slice",
          "slices",
          "pinch",
          "pinches",
          "dash",
          "dashes",
        ];
        // Remove quantities, units, and common descriptors
        return rest
          .toLowerCase()
          .replace(
            /to taste|diced|minced|sliced|chopped|crushed|fresh|for garnish/g,
            ""
          ) // Remove descriptors
          .replace(/\(.*?\)/g, "") // Remove parentheticals (e.g., "(14 oz each)")
          .replace(new RegExp(`\\b(${units.join("|")})\\b`, "g"), "") // Remove units
          .replace(/[^a-z\s&]/g, "") // Keep letters, spaces, and &
          .replace(/\s+/g, " ") // Normalize spaces
          .trim();
      };

      // Toast notification component
      const Toast = ({ message, type, onClose }) => {
        useEffect(() => {
          const timer = setTimeout(onClose, 3000);
          return () => clearTimeout(timer);
        }, [onClose]);

        return (
          <div
            className={`fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${
              type === "success" ? "bg-green-500" : "bg-red-500"
            }`}
          >
            {message}
          </div>
        );
      };

      // Main App component
      const App = () => {
        const [state, setState] = useState({
          recipes: JSON.parse(
            localStorage.getItem(STORAGE_KEYS.RECIPES) ||
              JSON.stringify(sampleRecipes)
          ),
          mealPlan: JSON.parse(
            localStorage.getItem(STORAGE_KEYS.MEAL_PLAN) || "{}"
          ),
          shoppingList: JSON.parse(
            localStorage.getItem(STORAGE_KEYS.SHOPPING_LIST) || "[]"
          ),
          isDarkMode: localStorage.getItem(STORAGE_KEYS.THEME) === "dark",
          showAddRecipeModal: false,
          showRecipeDetails: null,
          showMealPlanModal: false,
          showShoppingListModal: false,
          editingRecipe: null,
          toasts: [],
        });

        useEffect(() => {
          initializeMealPlan();
          applyTheme(state.isDarkMode);
        }, []);

        useEffect(() => {
          applyTheme(state.isDarkMode);
        }, [state.isDarkMode]);

        useEffect(() => {
          localStorage.setItem(
            STORAGE_KEYS.RECIPES,
            JSON.stringify(state.recipes)
          );
        }, [state.recipes]);

        useEffect(() => {
          localStorage.setItem(
            STORAGE_KEYS.MEAL_PLAN,
            JSON.stringify(state.mealPlan)
          );
        }, [state.mealPlan]);

        useEffect(() => {
          localStorage.setItem(
            STORAGE_KEYS.SHOPPING_LIST,
            JSON.stringify(state.shoppingList)
          );
        }, [state.shoppingList]);

        const applyTheme = (isDark) => {
          document.documentElement.classList.toggle("dark", isDark);
          localStorage.setItem(STORAGE_KEYS.THEME, isDark ? "dark" : "light");
        };

        const addToast = (message, type) => {
          setState((prev) => ({
            ...prev,
            toasts: [...prev.toasts, { id: Date.now(), message, type }],
          }));
        };

        const removeToast = (id) => {
          setState((prev) => ({
            ...prev,
            toasts: prev.toasts.filter((toast) => toast.id !== id),
          }));
        };

        const toggleTheme = () => {
          setState((prev) => ({ ...prev, isDarkMode: !prev.isDarkMode }));
        };

        const addRecipe = (recipeData) => {
          const recipe = {
            id: Date.now().toString(),
            ...recipeData,
            createdAt: new Date().toISOString(),
            isFavorite: false,
          };
          setState((prev) => ({
            ...prev,
            recipes: [...prev.recipes, recipe],
            showAddRecipeModal: false,
            editingRecipe: null,
          }));
          addToast("Recipe added successfully!", "success");
        };

        const updateRecipe = (id, recipeData) => {
          setState((prev) => ({
            ...prev,
            recipes: prev.recipes.map((recipe) =>
              recipe.id === id ? { ...recipe, ...recipeData } : recipe
            ),
            showAddRecipeModal: false,
            editingRecipe: null,
          }));
          addToast("Recipe updated successfully!", "success");
        };

        const deleteRecipe = (id) => {
          setState((prev) => {
            const newRecipes = prev.recipes.filter(
              (recipe) => recipe.id !== id
            );
            const newMealPlan = { ...prev.mealPlan };
            Object.keys(newMealPlan).forEach((day) => {
              Object.keys(newMealPlan[day]).forEach((mealTime) => {
                if (newMealPlan[day][mealTime] === id) {
                  delete newMealPlan[day][mealTime];
                }
              });
            });
            const newShoppingList = prev.shoppingList.filter(
              (item) => item.recipeId !== id
            );
            return {
              ...prev,
              recipes: newRecipes,
              mealPlan: newMealPlan,
              shoppingList: newShoppingList,
            };
          });
          addToast("Recipe deleted successfully!", "success");
        };

        const toggleFavorite = (id) => {
          setState((prev) => ({
            ...prev,
            recipes: prev.recipes.map((recipe) =>
              recipe.id === id
                ? { ...recipe, isFavorite: !recipe.isFavorite }
                : recipe
            ),
          }));
          addToast("Favorite toggled!", "success");
        };

        const searchRecipes = (query, filters) => {
          return state.recipes.filter((recipe) => {
            const matchesQuery = query
              ? recipe.name.toLowerCase().includes(query.toLowerCase()) ||
                recipe.type.toLowerCase().includes(query.toLowerCase()) ||
                (recipe.dietaryTypes &&
                  recipe.dietaryTypes.some((type) =>
                    type.toLowerCase().includes(query.toLowerCase())
                  ))
              : true;
            const matchesType = filters.type
              ? recipe.type === filters.type
              : true;
            const matchesDietary = filters.dietaryType
              ? recipe.dietaryTypes?.includes(filters.dietaryType)
              : true;
            const matchesFavorite = filters.favorites
              ? recipe.isFavorite
              : true;
            const totalTime =
              parseInt(recipe.prepTime || 0) +
              parseInt(recipe.cookTime || 0) +
              parseInt(recipe.additionalTime || 0);
            const matchesCookTime = filters.cookTime
              ? totalTime <= parseInt(filters.cookTime)
              : true;
            return (
              matchesQuery &&
              matchesType &&
              matchesDietary &&
              matchesFavorite &&
              matchesCookTime
            );
          });
        };

        const initializeMealPlan = () => {
          const days = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
          ];
          const mealTimes = [
            "breakfast",
            "morningSnack",
            "lunch",
            "afternoonSnack",
            "dinner",
          ];
          const newMealPlan = { ...state.mealPlan };
          days.forEach((day) => {
            if (!newMealPlan[day]) {
              newIVALPlan[day] = {};
              mealTimes.forEach((mealTime) => {
                newMealPlan[day][mealTime] = null;
              });
            }
          });
          setState((prev) => ({ ...prev, mealPlan: newMealPlan }));
        };

        const updateMealPlan = (day, mealTime, recipeId) => {
          setState((prev) => ({
            ...prev,
            mealPlan: {
              ...prev.mealPlan,
              [day]: {
                ...prev.mealPlan[day],
                [mealTime]: recipeId,
              },
            },
          }));
          addToast("Meal plan updated!", "success");
        };

        const removeMealFromPlan = (day, mealTime) => {
          setState((prev) => {
            const newMealPlan = { ...prev.mealPlan };
            if (newMealPlan[day] && newMealPlan[day][mealTime]) {
              delete newMealPlan[day][mealTime];
              return { ...prev, mealPlan: newMealPlan };
            }
            return prev;
          });
          addToast("Meal removed from plan!", "success");
        };

        const addToShoppingList = (recipeId) => {
          const recipe = state.recipes.find((r) => r.id === recipeId);
          if (!recipe) return;
          const newItems = recipe.ingredients.map((ingredient) => ({
            id: Date.now().toString() + Math.random(),
            text: ingredient,
            recipeId: recipe.id,
            recipeName: recipe.name,
            checked: false,
            normalizedText: normalizeIngredient(ingredient),
          }));
          setState((prev) => ({
            ...prev,
            shoppingList: [...prev.shoppingList, ...newItems],
          }));
          addToast("Added to shopping list!", "success");
        };

        const toggleShoppingItem = (itemId, normalizedText) => {
          try {
            setState((prev) => {
              const targetChecked = itemId
                ? !prev.shoppingList.find((i) => i.id === itemId)?.checked
                : !prev.shoppingList.find(
                    (i) => i.normalizedText === normalizedText
                  )?.checked;
              return {
                ...prev,
                shoppingList: prev.shoppingList.map((item) => {
                  if (
                    (itemId && item.id === itemId) ||
                    (normalizedText && item.normalizedText === normalizedText)
                  ) {
                    return { ...item, checked: targetChecked };
                  }
                  return item;
                }),
              };
            });
          } catch (error) {
            console.error("Error toggling shopping item:", error);
            addToast("Failed to update shopping list", "error");
          }
        };

        const clearShoppingList = () => {
          setState((prev) => ({
            ...prev,
            shoppingList: [],
            showShoppingListModal: false,
          }));
          addToast("Shopping list cleared!", "success");
        };

        const generateRecipePDF = async (recipe) => {
          const content = document.createElement("div");
          content.className = "recipe-pdf";
          content.style.cssText = `
          font-family: Arial, sans-serif;
          padding: 20px;
          margin: 0;
          line-height: 1.6;
          color: #000000;
        `;
          const imageHtml = recipe.image
            ? `<img src="${recipe.image}" style="max-width: 300px; max-height: 300px; display: block; margin: 0 auto 20px;" />`
            : `<div style="text-align: center; margin-bottom: 20px;">Image Not Available</div>`;
          content.innerHTML = `
          ${imageHtml}
          <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="color: #2ecc71; margin: 0;">${escapeHTML(
              recipe.name
            )}</h1>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; color: #000000;">
            <div>
              <h3 style="color: #2ecc71;">Recipe Details</h3>
              <p><strong>Type:</strong> ${escapeHTML(recipe.type)}</p>
              <p><strong>Dietary Types:</strong> ${
                recipe.dietaryTypes?.map(escapeHTML).join(", ") || "None"
              }</p>
              <p><strong>Prep Time:</strong> ${recipe.prepTime || 0} mins</p>
              <p><strong>Cook Time:</strong> ${recipe.cookTime || 0} mins</p>
              <p><strong>Additional Time:</strong> ${
                recipe.additionalTime || 0
              } mins</p>
              <p><strong>Total Time:</strong> ${
                parseInt(recipe.prepTime || 0) +
                parseInt(recipe.cookTime || 0) +
                parseInt(recipe.additionalTime || 0)
              } mins</p>
            </div>
            <div>
              <h3 style="color: #2ecc71;">Nutrition Facts</h3>
              <p>Calories: ${recipe.calories || "N/A"}</p>
              <p>Protein: ${recipe.protein ? recipe.protein + "g" : "N/A"}</p>
              <p>Carbs: ${recipe.carbs ? recipe.carbs + "g" : "N/A"}</p>
              <p>Fat: ${recipe.fat ? recipe.fat + "g" : "N/A"}</p>
            </div>
          </div>
          <div style="margin-bottom: 20px; color: #000000;">
            <h3 style="color: #2ecc71;">Ingredients</h3>
            <ul style="list-style: disc; padding-left: 20px;">
              ${recipe.ingredients
                .map((ing) => `<li>${escapeHTML(ing)}</li>`)
                .join("")}
            </ul>
          </div>
          <div style="color: #000000;">
            <h3 style="color: #2ecc71;">Directions</h3>
            <ol style="padding-left: 20px;">
              ${recipe.directions
                .map((dir) => `<li>${escapeHTML(dir)}</li>`)
                .join("")}
            </ol>
          </div>
        `;
          const opt = {
            margin: [0.5, 0.5, 0.5, 0.5],
            filename: `${recipe.name
              .toLowerCase()
              .replace(/\s+/g, "-")}-recipe.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
            pagebreak: { mode: ["avoid-all", "css", "legacy"] },
          };
          try {
            await html2pdf().set(opt).from(content).save();
            addToast("PDF downloaded successfully!", "success");
          } catch (error) {
            console.error("Error generating PDF:", error);
            addToast("Failed to generate PDF", "error");
          }
        };

        return (
          <div className="min-h-screen">
            <Header
              toggleTheme={toggleTheme}
              isDarkMode={state.isDarkMode}
              openAddRecipeModal={() =>
                setState((prev) => ({
                  ...prev,
                  showAddRecipeModal: true,
                  editingRecipe: null,
                }))
              }
              openMealPlanModal={() =>
                setState((prev) => ({ ...prev, showMealPlanModal: true }))
              }
              openShoppingListModal={() =>
                setState((prev) => ({ ...prev, showShoppingListModal: true }))
              }
            />
            <main className="max-w-7xl mx-auto p-4">
              <RecipeCarousel
                recipes={state.recipes}
                searchRecipes={searchRecipes}
                openRecipeDetails={(recipe) =>
                  setState((prev) => ({ ...prev, showRecipeDetails: recipe }))
                }
                toggleFavorite={toggleFavorite}
              />
            </main>
            {state.showAddRecipeModal && (
              <AddRecipeModal
                onClose={() =>
                  setState((prev) => ({
                    ...prev,
                    showAddRecipeModal: false,
                    editingRecipe: null,
                  }))
                }
                addRecipe={addRecipe}
                updateRecipe={updateRecipe}
                editingRecipe={state.editingRecipe}
              />
            )}
            {state.showRecipeDetails && (
              <RecipeDetailsModal
                recipe={state.showRecipeDetails}
                onClose={() =>
                  setState((prev) => ({ ...prev, showRecipeDetails: null }))
                }
                addToShoppingList={addToShoppingList}
                generatePDF={generateRecipePDF}
                deleteRecipe={deleteRecipe}
                editRecipe={(recipe) =>
                  setState((prev) => ({
                    ...prev,
                    showAddRecipeModal: true,
                    editingRecipe: recipe,
                    showRecipeDetails: null,
                  }))
                }
                toggleFavorite={toggleFavorite}
              />
            )}
            {state.showMealPlanModal && (
              <MealPlanModal
                mealPlan={state.mealPlan}
                recipes={state.recipes}
                updateMealPlan={updateMealPlan}
                removeMealFromPlan={removeMealFromPlan}
                onClose={() =>
                  setState((prev) => ({ ...prev, showMealPlanModal: false }))
                }
              />
            )}
            {state.showShoppingListModal && (
              <ShoppingListModal
                shoppingList={state.shoppingList}
                toggleShoppingItem={toggleShoppingItem}
                clearShoppingList={clearShoppingList}
                onClose={() =>
                  setState((prev) => ({
                    ...prev,
                    showShoppingListModal: false,
                  }))
                }
              />
            )}
            {state.toasts.map((toast) => (
              <Toast
                key={toast.id}
                message={toast.message}
                type={toast.type}
                onClose={() => removeToast(toast.id)}
              />
            ))}
          </div>
        );
      };

      // Header component
      const Header = ({
        toggleTheme,
        isDarkMode,
        openAddRecipeModal,
        openMealPlanModal,
        openShoppingListModal,
      }) => (
        <header className="bg-gray-200 dark:bg-gray-800 shadow-lg p-4 sticky top-0 z-50">
          <nav className="max-w-7xl mx-auto flex justify-between items-center flex-wrap gap-4">
            <h1 className="text-2xl font-bold text-green-500">
              Recipe Manager Pro
            </h1>
            <div className="flex items-center gap-4 flex-wrap">
              <div className="flex items-center bg-white dark:bg-gray-700 rounded-full px-3 py-2">
                <i className="fas fa-search text-gray-500 mr-2"></i>
                <input
                  type="text"
                  placeholder="Search recipes..."
                  className="bg-transparent outline-none text-gray-900 dark:text-gray-100"
                  onChange={(e) =>
                    document.dispatchEvent(
                      new CustomEvent("searchRecipes", {
                        detail: e.target.value,
                      })
                    )
                  }
                />
              </div>
              <button
                onClick={toggleTheme}
                className="p-2 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600"
                title="Toggle Light/Dark Mode"
              >
                <i
                  className={`fas ${
                    isDarkMode ? "fa-sun" : "fa-moon"
                  } text-gray-900 dark:text-gray-100`}
                ></i>
              </button>
              <button
                onClick={openMealPlanModal}
                className="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-4 py-2 rounded-full hover:bg-gray-400 dark:hover:bg-gray-600 flex items-center gap-2"
              >
                <i className="fas fa-calendar-alt"></i>
                Meal Plan
              </button>
              <button
                onClick={openShoppingListModal}
                className="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-4 py-2 rounded-full hover:bg-gray-400 dark:hover:bg-gray-600 flex items-center gap-2"
              >
                <i className="fas fa-shopping-cart"></i>
                Shopping List
              </button>
              <button
                onClick={openAddRecipeModal}
                className="bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 flex items-center gap-2"
              >
                <i className="fas fa-plus"></i>
                Add Recipe
              </button>
            </div>
          </nav>
        </header>
      );

      // Recipe Carousel component
      const RecipeCarousel = ({
        recipes,
        searchRecipes,
        openRecipeDetails,
        toggleFavorite,
      }) => {
        const [filteredRecipes, setFilteredRecipes] = useState(recipes);
        const [filters, setFilters] = useState({
          query: "",
          type: "",
          dietaryType: "",
          cookTime: "",
          favorites: false,
        });
        const [carouselIndex, setCarouselIndex] = useState(0);
        const carouselRef = useRef(null);

        useEffect(() => {
          setFilteredRecipes(searchRecipes(filters.query, filters));
        }, [recipes, filters]);

        useEffect(() => {
          const handler = (e) => {
            setFilters((prev) => ({ ...prev, query: e.detail }));
          };
          document.addEventListener("searchRecipes", handler);
          return () => document.removeEventListener("searchRecipes", handler);
        }, []);

        const handleFilterChange = (e) => {
          const { name, value, type, checked } = e.target;
          setFilters((prev) => ({
            ...prev,
            [name]: type === "checkbox" ? checked : value,
          }));
          setCarouselIndex(0);
        };

        const scrollLeft = () => {
          if (carouselIndex > 0) {
            setCarouselIndex((prev) => prev - 1);
          }
        };

        const scrollRight = () => {
          if (carouselIndex < filteredRecipes.length - 1) {
            setCarouselIndex((prev) => prev + 1);
          }
        };

        useEffect(() => {
          if (carouselRef.current) {
            const cardWidth = 320 + 16;
            carouselRef.current.style.transform = `translateX(-${
              carouselIndex * cardWidth
            }px)`;
          }
        }, [carouselIndex, filteredRecipes]);

        return (
          <div>
            <div className="mb-6 flex flex-wrap gap-4">
              <select
                name="type"
                value={filters.type}
                onChange={handleFilterChange}
                className="p-2 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              >
                <option value="">All Meal Types</option>
                {[
                  "Breakfast",
                  "Lunch",
                  "Dinner",
                  "Snack",
                  "Dessert",
                  "Side Dish",
                ].map((type) => (
                  <option key={type} value={type}>
                    {type}
                  </option>
                ))}
              </select>
              <select
                name="dietaryType"
                value={filters.dietaryType}
                onChange={handleFilterChange}
                className="p-2 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              >
                <option value="">All Dietary Types</option>
                {[
                  "Gluten-Free",
                  "Dairy-Free",
                  "Nut-Free",
                  "Vegan",
                  "Vegetarian",
                ].map((type) => (
                  <option key={type} value={type}>
                    {type}
                  </option>
                ))}
              </select>
              <select
                name="cookTime"
                value={filters.cookTime}
                onChange={handleFilterChange}
                className="p-2 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
              >
                <option value="">Total Time</option>
                {[15, 30, 45, 60, 75, 90].map((time) => (
                  <option key={time} value={time}>
                    Under {time} mins
                  </option>
                ))}
              </select>
              <label className="flex items-center gap-2">
                <input
                  type="checkbox"
                  name="favorites"
                  checked={filters.favorites}
                  onChange={handleFilterChange}
                  className="w-5 h-5"
                />
                Favorites Only
              </label>
            </div>
            <div className="relative">
              {filteredRecipes.length > 0 ? (
                <>
                  <button
                    onClick={scrollLeft}
                    disabled={carouselIndex === 0}
                    className="absolute left-0 top-1/2 transform -translate-y-1/2 bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 p-2 rounded-full hover:bg-gray-400 dark:hover:bg-gray-600 disabled:opacity-50 z-10"
                  >
                    <i className="fas fa-chevron-left"></i>
                  </button>
                  <button
                    onClick={scrollRight}
                    disabled={carouselIndex >= filteredRecipes.length - 1}
                    className="absolute right-0 top-1/2 transform -translate-y-1/2 bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 p-2 rounded-full hover:bg-gray-400 dark:hover:bg-gray-600 disabled:opacity-50 z-10"
                  >
                    <i className="fas fa-chevron-right"></i>
                  </button>
                  <div className="overflow-hidden">
                    <div
                      ref={carouselRef}
                      className="flex transition-transform duration-500 ease-in-out"
                    >
                      {filteredRecipes.map((recipe) => (
                        <div
                          key={recipe.id}
                          className="flex-shrink-0 w-80 mx-2"
                        >
                          <div
                            className="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition-shadow duration-300"
                            onClick={() => openRecipeDetails(recipe)}
                          >
                            <div className="w-full h-48 flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                              {recipe.image ? (
                                <img
                                  src={recipe.image}
                                  alt={recipe.name}
                                  className="max-w-full max-h-full object-cover"
                                />
                              ) : (
                                <div className="text-gray-500 dark:text-gray-400 text-center">
                                  Image Not Available
                                </div>
                              )}
                            </div>
                            <div className="p-4">
                              <div className="flex justify-between items-center">
                                <h3 className="text-lg font-semibold">
                                  {escapeHTML(recipe.name)}
                                </h3>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    toggleFavorite(recipe.id);
                                  }}
                                  className="text-yellow-500 hover:text-yellow-600"
                                >
                                  <i
                                    className={`fas fa-star ${
                                      recipe.isFavorite
                                        ? "text-yellow-500"
                                        : "text-gray-400"
                                    }`}
                                  ></i>
                                </button>
                              </div>
                              <span className="inline-block bg-green-500 text-white text-xs px-2 py-1 rounded-full mt-2">
                                {escapeHTML(recipe.type)}
                              </span>
                              {recipe.dietaryTypes?.length > 0 && (
                                <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">
                                  {recipe.dietaryTypes
                                    .map(escapeHTML)
                                    .join(", ")}
                                </p>
                              )}
                              <div className="mt-2 text-sm text-gray-500 dark:text-gray-400 grid grid-cols-2 gap-2">
                                {recipe.prepTime && (
                                  <span>
                                    <i className="fas fa-clock mr-1"></i> Prep:{" "}
                                    {recipe.prepTime}m
                                  </span>
                                )}
                                {recipe.cookTime && (
                                  <span>
                                    <i className="fas fa-fire mr-1"></i> Cook:{" "}
                                    {recipe.cookTime}m
                                  </span>
                                )}
                                {recipe.additionalTime !== 0 && (
                                  <span>
                                    <i className="fas fa-hourglass mr-1"></i>{" "}
                                    Add'l: {recipe.additionalTime}m
                                  </span>
                                )}
                                <span className="col-span-2 text-green-500 font-medium">
                                  <i className="fas fa-clock mr-1"></i> Total:{" "}
                                  {parseInt(recipe.prepTime || 0) +
                                    parseInt(recipe.cookTime || 0) +
                                    parseInt(recipe.additionalTime || 0)}
                                  m
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </>
              ) : (
                <p className="text-center text-gray-500 dark:text-gray-400">
                  No recipes found.
                </p>
              )}
            </div>
          </div>
        );
      };

      // Add/Edit Recipe Modal
      const AddRecipeModal = ({
        onClose,
        addRecipe,
        updateRecipe,
        editingRecipe,
      }) => {
        const [formData, setFormData] = useState({
          name: "",
          type: "",
          dietaryTypes: "",
          prepTime: "",
          cookTime: "",
          additionalTime: "0",
          calories: "",
          protein: "",
          carbs: "",
          fat: "",
          servings: "4",
          ingredients: "",
          directions: "",
          image: null,
          video: null,
        });

        useEffect(() => {
          if (editingRecipe) {
            setFormData({
              name: editingRecipe.name || "",
              type: editingRecipe.type || "",
              dietaryTypes: editingRecipe.dietaryTypes?.join(", ") || "",
              prepTime: editingRecipe.prepTime || "",
              cookTime: editingRecipe.cookTime || "",
              additionalTime: editingRecipe.additionalTime || "0",
              calories: editingRecipe.calories || "",
              protein: editingRecipe.protein || "",
              carbs: editingRecipe.carbs || "",
              fat: editingRecipe.fat || "",
              servings: editingRecipe.servings || "4",
              ingredients: editingRecipe.ingredients?.join("\n") || "",
              directions: editingRecipe.directions?.join("\n") || "",
              image: editingRecipe.image || null,
              video: editingRecipe.video || null,
            });
          }
        }, [editingRecipe]);

        const handleChange = (e) => {
          const { name, value, files } = e.target;
          if (files) {
            const file = files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = () => {
                setFormData((prev) => ({ ...prev, [name]: reader.result }));
              };
              reader.readAsDataURL(file);
            }
          } else {
            setFormData((prev) => ({ ...prev, [name]: value }));
          }
        };

        const removeVideo = () => {
          setFormData((prev) => ({ ...prev, video: null }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          const recipeData = {
            name: formData.name.trim(),
            type: formData.type.trim(),
            dietaryTypes: formData.dietaryTypes
              ? formData.dietaryTypes
                  .split(",")
                  .map((t) => t.trim())
                  .filter(Boolean)
              : [],
            prepTime: parseInt(formData.prepTime) || 0,
            cookTime: parseInt(formData.cookTime) || 0,
            additionalTime: parseInt(formData.additionalTime) || 0,
            calories: parseInt(formData.calories) || null,
            protein: parseInt(formData.protein) || null,
            carbs: parseInt(formData.carbs) || null,
            fat: parseInt(formData.fat) || null,
            servings: parseInt(formData.servings) || 4,
            ingredients: formData.ingredients
              ? formData.ingredients
                  .split("\n")
                  .map((i) => i.trim())
                  .filter(Boolean)
              : [],
            directions: formData.directions
              ? formData.directions
                  .split("\n")
                  .map((d) => d.trim())
                  .filter(Boolean)
              : [],
            image: formData.image,
            video: formData.video,
          };
          if (editingRecipe) {
            updateRecipe(editingRecipe.id, recipeData);
          } else {
            addRecipe(recipeData);
          }
          setFormData({
            name: "",
            type: "",
            dietaryTypes: "",
            prepTime: "",
            cookTime: "",
            additionalTime: "0",
            calories: "",
            protein: "",
            carbs: "",
            fat: "",
            servings: "4",
            ingredients: "",
            directions: "",
            image: null,
            video: null,
          });
          onClose();
        };

        const handleOverlayClick = (e) => {
          if (e.target === e.currentTarget) {
            onClose();
          }
        };

        return (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            onClick={handleOverlayClick}
          >
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">
                  {editingRecipe ? "Edit Recipe" : "Add New Recipe"}
                </h2>
                <button onClick={onClose} className="text-2xl">
                  ×
                </button>
              </div>
              <form
                onSubmit={handleSubmit}
                className="grid grid-cols-1 md:grid-cols-2 gap-4"
              >
                <div>
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Recipe Name
                  </label>
                  <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleChange}
                    required
                    className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Meal Type
                  </label>
                  <input
                    type="text"
                    name="type"
                    value={formData.type}
                    onChange={handleChange}
                    list="meal-types"
                    required
                    className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                  <datalist id="meal-types">
                    {[
                      "Breakfast",
                      "Lunch",
                      "Dinner",
                      "Snack",
                      "Dessert",
                      "Side Dish",
                    ].map((type) => (
                      <option key={type} value={type} />
                    ))}
                  </datalist>
                </div>
                <div>
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Servings
                  </label>
                  <input
                    type="number"
                    name="servings"
                    value={formData.servings}
                    onChange={handleChange}
                    min="1"
                    required
                    className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Dietary Types (comma-separated)
                  </label>
                  <input
                    type="text"
                    name="dietaryTypes"
                    value={formData.dietaryTypes}
                    onChange={handleChange}
                    list="dietary-types"
                    className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                  <datalist id="dietary-types">
                    {[
                      "Gluten-Free",
                      "Dairy-Free",
                      "Nut-Free",
                      "Vegan",
                      "Vegetarian",
                    ].map((type) => (
                      <option key={type} value={type} />
                    ))}
                  </datalist>
                </div>
                <div>
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Recipe Image
                  </label>
                  <input
                    type="file"
                    name="image"
                    accept="image/*"
                    onChange={handleChange}
                    className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  />
                  {formData.image && (
                    <img
                      src={formData.image}
                      alt="Preview"
                      className="mt-2 max-w-[300px] max-h-[300px] object-contain"
                    />
                  )}
                </div>
                <div>
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Instructional Video
                  </label>
                  <div className="flex items-center gap-2">
                    <input
                      type="file"
                      name="video"
                      accept="video/*"
                      onChange={handleChange}
                      className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    />
                    {formData.video && editingRecipe && (
                      <button
                        type="button"
                        onClick={removeVideo}
                        className="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                      >
                        Remove Video
                      </button>
                    )}
                  </div>
                </div>
                <div className="col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-100 dark:bg-gray-700 p-4 rounded">
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                      Prep Time (mins)
                    </label>
                    <input
                      type="number"
                      name="prepTime"
                      value={formData.prepTime}
                      onChange={handleChange}
                      min="0"
                      required
                      className="w-full p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                      Cook Time (mins)
                    </label>
                    <input
                      type="number"
                      name="cookTime"
                      value={formData.cookTime}
                      onChange={handleChange}
                      min="0"
                      required
                      className="w-full p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                      Additional Time (mins)
                    </label>
                    <input
                      type="number"
                      name="additionalTime"
                      value={formData.additionalTime}
                      onChange={handleChange}
                      min="0"
                      className="w-full p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                    />
                  </div>
                </div>
                <div className="col-span-2 grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-100 dark:bg-gray-700 p-4 rounded">
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                      Calories
                    </label>
                    <input
                      type="number"
                      name="calories"
                      value={formData.calories}
                      onChange={handleChange}
                      min="0"
                      className="w-full p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                      Protein (g)
                    </label>
                    <input
                      type="number"
                      name="protein"
                      value={formData.protein}
                      onChange={handleChange}
                      min="0"
                      className="w-full p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                      Carbs (g)
                    </label>
                    <input
                      type="number"
                      name="carbs"
                      value={formData.carbs}
                      onChange={handleChange}
                      min="0"
                      className="w-full p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                      Fat (g)
                    </label>
                    <input
                      type="number"
                      name="fat"
                      value={formData.fat}
                      onChange={handleChange}
                      min="0"
                      className="w-full p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                    />
                  </div>
                </div>
                <div className="col-span-2">
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Ingredients (one per line)
                  </label>
                  <textarea
                    name="ingredients"
                    value={formData.ingredients}
                    onChange={handleChange}
                    rows="5"
                    required
                    className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  ></textarea>
                </div>
                <div className="col-span-2">
                  <label className="block text-sm text-gray-600 dark:text-gray-400 mb-2">
                    Directions (one step per line)
                  </label>
                  <textarea
                    name="directions"
                    value={formData.directions}
                    onChange={handleChange}
                    rows="5"
                    required
                    className="w-full p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                  ></textarea>
                </div>
                <div className="col-span-2 flex gap-4">
                  <button
                    type="submit"
                    className="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600"
                  >
                    Save Recipe
                  </button>
                  <button
                    type="button"
                    onClick={onClose}
                    className="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-6 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-600"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      // Recipe Details Modal
      const RecipeDetailsModal = ({
        recipe,
        onClose,
        addToShoppingList,
        generatePDF,
        deleteRecipe,
        editRecipe,
        toggleFavorite,
      }) => {
        const [servings, setServings] = useState(recipe.servings || 4);

        const handleServingsChange = (delta) => {
          setServings((prev) => Math.max(1, prev + delta));
        };

        const totalTime =
          parseInt(recipe.prepTime || 0) +
          parseInt(recipe.cookTime || 0) +
          parseInt(recipe.additionalTime || 0);

        const handleOverlayClick = (e) => {
          if (e.target === e.currentTarget) {
            onClose();
          }
        };

        return (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            onClick={handleOverlayClick}
          >
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">
                  {escapeHTML(recipe.name)}
                </h2>
                <button onClick={onClose} className="text-2xl">
                  ×
                </button>
              </div>
              <div className="flex flex-wrap gap-2 mb-4">
                <span className="bg-green-500 text-white text-sm px-3 py-1 rounded-full">
                  {escapeHTML(recipe.type)}
                </span>
                {recipe.dietaryTypes?.map((type) => (
                  <span
                    key={type}
                    className="bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm px-3 py-1 rounded-full"
                  >
                    {escapeHTML(type)}
                  </span>
                ))}
              </div>
              {recipe.image && (
                <img
                  src={recipe.image}
                  alt={recipe.name}
                  className="w-full max-w-[300px] max-h-[300px] object-contain rounded-lg mb-4 mx-auto"
                />
              )}
              {recipe.video && (
                <div className="mb-4">
                  <h3 className="text-lg font-semibold">
                    Instruction喜欢 Video
                  </h3>
                  <video controls className="w-full max-w-md rounded-lg">
                    <source src={recipe.video} type="video/mp4" />
                    Your browser does not support the video tag.
                  </video>
                </div>
              )}
              <div className="flex items-center gap-4 mb-4 bg-gray-100 dark:bg-gray-700 p-4 rounded">
                <label className="font-medium">Servings:</label>
                <button
                  onClick={() => handleServingsChange(-1)}
                  className="bg-gray-300 dark:bg-gray-600 px-3 py-1 rounded hover:bg-gray-400 dark:hover:bg-gray-500"
                >
                  <i className="fas fa-minus"></i>
                </button>
                <input
                  type="number"
                  value={servings}
                  onChange={(e) =>
                    setServings(Math.max(1, parseInt(e.target.value) || 1))
                  }
                  min="1"
                  className="w-16 text-center p-2 rounded bg-white dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                />
                <button
                  onClick={() => handleServingsChange(1)}
                  className="bg-gray-300 dark:bg-gray-600 px-3 py-1 rounded hover:bg-gray-400 dark:hover:bg-gray-500"
                >
                  <i className="fas fa-plus"></i>
                </button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 bg-gray-100 dark:bg-gray-700 p-4 rounded">
                <div>
                  <h3 className="text-lg font-semibold mb-2">Time</h3>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="flex items-center gap-2">
                      <i className="fas fa-clock text-green-500"></i>
                      <span>Prep: {recipe.prepTime || 0} mins</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <i className="fas fa-fire text-green-500"></i>
                      <span>Cook: {recipe.cookTime || 0} mins</span>
                    </div>
                    {recipe.additionalTime !== 0 && (
                      <div className="flex items-center gap-2">
                        <i className="fas fa-hourglass text-green-500"></i>
                        <span>Additional: {recipe.additionalTime} mins</span>
                      </div>
                    )}
                    <div className="col-span-2 flex items-center gap-2 text-green-500 font-medium">
                      <i className="fas fa-clock"></i>
                      <span>Total: {totalTime} mins</span>
                    </div>
                  </div>
                </div>
                <div>
                  <h3 className="text-lg font-semibold mb-2">Nutrition</h3>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="text-center p-2 bg-white dark:bg-gray-600 rounded shadow">
                      <span className="block text-xl font-bold text-green-500">
                        {recipe.calories || "N/A"}
                      </span>
                      <span className="text-sm text-gray-500 dark:text-gray-400">
                        Calories
                      </span>
                    </div>
                    <div className="text-center p-2 bg-white dark:bg-gray-600 rounded shadow">
                      <span className="block text-xl font-bold text-green-500">
                        {recipe.protein ? `${recipe.protein}g` : "N/A"}
                      </span>
                      <span className="text-sm text-gray-500 dark:text-gray-400">
                        Protein
                      </span>
                    </div>
                    <div className="text-center p-2 bg-white dark:bg-gray-600 rounded shadow">
                      <span className="block text-xl font-bold text-green-500">
                        {recipe.carbs ? `${recipe.carbs}g` : "N/A"}
                      </span>
                      <span className="text-sm text-gray-500 dark:text-gray-400">
                        Carbs
                      </span>
                    </div>
                    <div className="text-center p-2 bg-white dark:bg-gray-600 rounded shadow">
                      <span className="block text-xl font-bold text-green-500">
                        {recipe.fat ? `${recipe.fat}g` : "N/A"}
                      </span>
                      <span className="text-sm text-gray-500 dark:text-gray-400">
                        Fat
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 className="text-lg font-semibold mb-2">
                    <i className="fas fa-list mr-2"></i>Ingredients
                  </h3>
                  <ul className="list-none">
                    {recipe.ingredients.map((ing, index) => {
                      const { quantity, rest } = parseIngredient(ing);
                      const scaledQuantity = quantity
                        ? (quantity * servings) / (recipe.servings || 4)
                        : null;
                      return (
                        <li
                          key={index}
                          className="flex items-center gap-2 py-2 border-b border-gray-200 dark:border-gray-700"
                        >
                          <i className="fas fa-check text-green-500"></i>
                          {scaledQuantity
                            ? `${formatQuantity(scaledQuantity)} `
                            : ""}
                          {escapeHTML(rest)}
                        </li>
                      );
                    })}
                  </ul>
                </div>
                <div>
                  <h3 className="text-lg font-semibold mb-2">
                    <i className="fas fa-tasks mr-2"></i>Directions
                  </h3>
                  <ol className="list-none">
                    {recipe.directions.map((dir, index) => (
                      <li
                        key={index}
                        className="mb-4 p-4 bg-gray-100 dark:bg-gray-700 rounded flex items-center"
                      >
                        <span className="bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center mr-2">
                          {index + 1}
                        </span>
                        {escapeHTML(dir)}
                      </li>
                    ))}
                  </ol>
                </div>
              </div>
              <div className="flex flex-wrap gap-4 mt-6">
                <button
                  onClick={() => generatePDF(recipe)}
                  className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center gap-2"
                >
                  <i className="fas fa-file-pdf"></i> Download PDF
                </button>
                <button
                  onClick={() => addToShoppingList(recipe.id)}
                  className="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-4 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-600 flex items-center gap-2"
                >
                  <i className="fas fa-shopping-cart"></i> Add to Shopping List
                </button>
                <button
                  onClick={() => editRecipe(recipe)}
                  className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center gap-2"
                >
                  <i className="fas fa-edit"></i> Edit Recipe
                </button>
                <button
                  onClick={() => {
                    if (
                      window.confirm(
                        "Are you sure you want to delete this recipe?"
                      )
                    ) {
                      deleteRecipe(recipe.id);
                      onClose();
                    }
                  }}
                  className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 flex items-center gap-2"
                >
                  <i className="fas fa-trash"></i> Delete Recipe
                </button>
                <button
                  onClick={() => toggleFavorite(recipe.id)}
                  className="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 flex items-center gap-2"
                >
                  <i
                    className={`fas fa-star ${
                      recipe.isFavorite ? "text-yellow-300" : ""
                    }`}
                  ></i>
                  {recipe.isFavorite
                    ? "Remove from Favorites"
                    : "Add to Favorites"}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Meal Plan Modal
      const MealPlanModal = ({
        mealPlan,
        recipes,
        updateMealPlan,
        removeMealFromPlan,
        onClose,
      }) => {
        const days = [
          "Sunday",
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
        ];
        const mealTimes = [
          { id: "breakfast", label: "Breakfast" },
          { id: "morningSnack", label: "Morning Snack" },
          { id: "lunch", label: "Lunch" },
          { id: "afternoonSnack", label: "Afternoon Snack" },
          { id: "dinner", label: "Dinner" },
        ];
        const [showRecipeSelector, setShowRecipeSelector] = useState(null);

        const handleSelectRecipe = (day, mealTime) => {
          setShowRecipeSelector({ day, mealTime });
        };

        const handleRecipeSelect = (recipeId) => {
          updateMealPlan(
            showRecipeSelector.day,
            showRecipeSelector.mealTime,
            recipeId
          );
          setShowRecipeSelector(null);
        };

        const handleOverlayClick = (e) => {
          if (e.target === e.currentTarget) {
            onClose();
          }
        };

        return (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            onClick={handleOverlayClick}
          >
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-7xl h-[90vh] flex flex-col">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold flex items-center gap-2">
                  <i className="fas fa-calendar-alt text-green-500"></i> Weekly
                  Meal Plan
                </h2>
                <button onClick={onClose} className="text-2xl">
                  ×
                </button>
              </div>
              <div className="flex-1 overflow-y-auto">
                <div className="grid grid-cols-1 md:grid-cols-7 gap-4">
                  {days.map((day) => (
                    <div key={day} className="min-w-[200px]">
                      <h3 className="text-lg font-semibold mb-4">{day}</h3>
                      {mealTimes.map(({ id, label }) => {
                        const recipeId = mealPlan[day]?.[id];
                        const recipe = recipeId
                          ? recipes.find((r) => r.id === recipeId)
                          : null;
                        return (
                          <div
                            key={id}
                            className="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-2 hover:border-green-500 border transition-colors"
                          >
                            <div className="flex justify-between items-center mb-2">
                              <h4 className="text-sm text-gray-500 dark:text-gray-400">
                                {label}
                              </h4>
                              {recipe && (
                                <button
                                  onClick={() => removeMealFromPlan(day, id)}
                                  className="text-red-500 hover:text-red-600"
                                  title="Remove meal"
                                >
                                  <i className="fas fa-trash-alt"></i>
                                </button>
                              )}
                            </div>
                            <div
                              onClick={() => handleSelectRecipe(day, id)}
                              className="cursor-pointer"
                            >
                              {recipe ? (
                                <p className="text-green-500 font-medium">
                                  {escapeHTML(recipe.name)}
                                </p>
                              ) : (
                                <p className="text-gray-500 dark:text-gray-400 italic">
                                  + Add Recipe
                                </p>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>
              </div>
              {showRecipeSelector && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60">
                  <div className="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-3xl max-h-[60vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-semibold">
                        Select Recipe for {showRecipeSelector.day} -{" "}
                        {showRecipeSelector.mealTime
                          .replace(/([A-Z])/g, " $1")
                          .toLowerCase()}
                      </h2>
                      <button
                        onClick={() => setShowRecipeSelector(null)}
                        className="text-2xl"
                      >
                        ×
                      </button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      {recipes.map((recipe) => (
                        <div
                          key={recipe.id}
                          onClick={() => handleRecipeSelect(recipe.id)}
                          className="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 cursor-pointer hover:border-green-500 border transition-colors"
                        >
                          <h4 className="font-semibold">
                            {escapeHTML(recipe.name)}
                          </h4>
                          <p className="text-sm text-gray-500 dark:text-gray-400">
                            {escapeHTML(recipe.type)}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      // Shopping List Modal
      const ShoppingListModal = ({
        shoppingList,
        toggleShoppingItem,
        clearShoppingList,
        onClose,
      }) => {
        const groupedItems = shoppingList.reduce((groups, item) => {
          const recipeName = item.recipeName || "Uncategorized";
          if (!groups[recipeName]) groups[recipeName] = [];
          groups[recipeName].push(item);
          return groups;
        }, {});

        const sharedIngredients = {};
        const recipeNames = Object.keys(groupedItems);
        if (recipeNames.length > 1) {
          const ingredientCounts = {};
          shoppingList.forEach((item) => {
            const normalized = item.normalizedText;
            if (!ingredientCounts[normalized]) {
              ingredientCounts[normalized] = {
                text: normalizeIngredient(item.text),
                recipes: new Set(),
                items: [],
              };
            }
            ingredientCounts[normalized].recipes.add(item.recipeName);
            ingredientCounts[normalized].items.push(item);
          });
          Object.entries(ingredientCounts).forEach(([normalized, data]) => {
            if (data.recipes.size > 1) {
              const allChecked = data.items.every((item) => item.checked);
              sharedIngredients[normalized] = {
                text: data.text,
                recipes: data.recipes,
                checked: allChecked,
              };
            }
          });
        }

        const handleOverlayClick = (e) => {
          if (e.target === e.currentTarget) {
            onClose();
          }
        };

        return (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            onClick={handleOverlayClick}
          >
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold flex items-center gap-2">
                  <i className="fas fa-shopping-cart text-green-500"></i>{" "}
                  Shopping List
                </h2>
                <button onClick={onClose} className="text-2xl">
                  ×
                </button>
              </div>
              <div className="mb-4">
                <button
                  onClick={clearShoppingList}
                  className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                >
                  Clear List
                </button>
              </div>
              {Object.keys(groupedItems).map((recipeName) => (
                <div key={recipeName} className="mb-4">
                  <h3 className="text-lg font-semibold text-green-500 border-b border-gray-200 dark:border-gray-600 pb-2 mb-2">
                    {escapeHTML(recipeName)}
                  </h3>
                  <ul className="list-none">
                    {groupedItems[recipeName].map((item) => (
                      <li
                        key={item.id}
                        className={`p-2 rounded ${
                          item.checked
                            ? "line-through text-gray-500 dark:text-gray-400"
                            : ""
                        }`}
                      >
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={item.checked}
                            onChange={() => toggleShoppingItem(item.id, null)}
                            className="w-5 h-5"
                          />
                          <span>{escapeHTML(item.text)}</span>
                        </label>
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
              {Object.keys(sharedIngredients).length > 0 && (
                <div className="mt-6">
                  <h3 className="text-lg font-semibold text-green-500 border-b border-gray-200 dark:border-gray-600 pb-2 mb-2">
                    Shared Ingredients
                  </h3>
                  <ul className="list-none">
                    {Object.entries(sharedIngredients).map(
                      ([normalized, { text, recipes, checked }]) => (
                        <li
                          key={normalized}
                          className={`p-2 rounded ${
                            checked
                              ? "line-through text-gray-500 dark:text-gray-400"
                              : ""
                          }`}
                        >
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={checked}
                              onChange={() =>
                                toggleShoppingItem(null, normalized)
                              }
                              className="w-5 h-5"
                            />
                            <span>
                              {escapeHTML(text)} (Used in:{" "}
                              {Array.from(recipes).map(escapeHTML).join(", ")})
                            </span>
                          </label>
                        </li>
                      )
                    )}
                  </ul>
                </div>
              )}
            </div>
          </div>
        );
      };

      // Render the app
      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'934e1b1f8c521d66',t:'MTc0NTQxOTEyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
